# AI总结日志监控指南

## 📖 概述

本指南介绍如何使用增强的日志功能来监控和调试智能分析（AI总结）功能。

## 🚀 新增的日志功能

### 1. API请求层日志
当用户在维度统计页面点击"智能分析"时，会记录：
- 🎯 请求开始时间和客户端信息
- 📋 获取badcase原因的详细过程
- 📊 人工评估原因的数量和内容摘要
- ⏱️ 每个步骤的处理时间

### 2. AI总结服务层日志  
在AI总结处理过程中，会详细记录：
- 🤖 完整的prompt内容（发送给大模型的请求）
- 📏 prompt长度统计
- ⏱️ 超时设置和API调用时间
- 📄 大模型的原始响应内容
- 🔧 JSON解析过程和结果

### 3. 异常处理日志
如果出现错误，会记录：
- ❌ 详细的异常类型和信息
- ⏰ 超时异常的特殊处理
- 📊 请求上下文信息

## 🛠️ 使用方法

### 方法1: 实时监控日志
```bash
# 进入后端目录
cd /data/macxin/intelligent-qa-evaluator/backend

# 实时监控AI总结相关日志
python watch_ai_summary_logs.py
```

这会实时显示所有与AI总结相关的日志，包括：
- 智能分析请求
- Prompt内容
- 大模型响应
- 处理结果

### 方法2: 查看最近的日志
```bash
# 查看最近50条AI总结相关日志
python watch_ai_summary_logs.py recent

# 查看最近100条日志
python watch_ai_summary_logs.py recent 100
```

### 方法3: 直接查看日志文件
```bash
# 查看完整日志
tail -f app.log

# 或者在生产环境
tail -f production.log

# 过滤AI总结相关日志
grep -i "智能分析\|AI总结\|prompt\|大模型" app.log
```

## 📋 日志内容说明

### 典型的智能分析日志流程：

```
🎯 [智能分析请求] 开始处理badcase AI总结
   - 请求分类: 个股分析
   - 请求时间: 2025-01-10 14:30:25
   - 客户端IP: 192.168.1.100

📋 第一步: 获取分类 个股分析 的人工评估badcase原因

📊 获取到的原因数据:
   - 总badcase记录数: 15
   - 人工评估原因数: 8

📝 人工评估原因详情:
   1. [记录#123] 回答不够准确，缺少关键信息...
   2. [记录#124] 数据过时，需要更新...
   ...

🤖 第二步: 启动AI总结服务

🤖 开始AI总结分析 - 分类: 个股分析

📝 发送给大模型的完整Prompt:
================================================================================
你是一个专业的质量分析专家，擅长分析问答系统的质量问题并提供改进建议...
[完整的prompt内容]
================================================================================

📏 Prompt长度: 2048字符
⏱️  设置超时时间: 300秒
🚀 开始调用大模型API...

✅ 大模型响应成功，响应长度: 1024字符

📄 大模型原始响应:
------------------------------------------------------------
{
  "main_issues": [
    {
      "type": "数据准确性问题",
      "description": "回答中包含过时或错误的信息",
      ...
    }
  ],
  ...
}
------------------------------------------------------------

🔧 开始解析AI总结结果...

📊 解析完成:
   - 分类: 个股分析
   - 人工评估原因数: 8条
   - 解析状态: 成功

✅ JSON解析成功，提取到 3 个主要问题

✅ [智能分析完成] badcase AI总结生成成功
   - 处理时长: 45.23秒
   - 分析分类: 个股分析
   - 总结状态: 成功
```

## 🔧 调试技巧

### 1. 检查Prompt质量
通过日志中的完整prompt，可以：
- 验证输入数据是否正确
- 检查prompt格式是否规范
- 确认人工评估原因是否完整

### 2. 分析超时问题
如果遇到超时，查看：
- ⏱️ 设置的超时时间
- 📏 Prompt长度（太长可能导致处理时间增加）
- 🚀 API调用开始时间

### 3. 验证响应解析
检查：
- 📄 大模型原始响应格式
- 🔧 JSON解析是否成功
- ✅ 提取的问题数量是否合理

## 🛡️ 故障排除

### 常见问题：

1. **找不到日志文件**
   ```bash
   # 检查后端服务是否运行
   ps aux | grep "python.*app.py"
   
   # 检查日志文件位置
   ls -la app.log production.log logs/app.log
   ```

2. **没有AI总结日志**
   - 确保后端服务已重启（应用新的日志配置）
   - 检查是否有人工评估的badcase原因
   - 验证分类名称是否正确

3. **超时问题持续**
   - 检查网络连接到大模型API
   - 考虑减少输入的原因数量
   - 增加超时时间设置

## 💡 最佳实践

1. **在测试智能分析前**，先运行实时监控
2. **保存重要的prompt和响应**用于后续分析
3. **定期查看处理时间**，优化性能
4. **关注异常日志**，及时处理问题

现在您可以详细监控智能分析的整个执行过程，包括发送给大模型的完整prompt！ 